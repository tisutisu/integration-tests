apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: e2e-tests-pipeline
spec:
  params:
    - description: 'Snapshot of the application'
      name: SNAPSHOT
      default: ''
      type: string
    - name: repo_url
      value: "{{ repo_url }}"
      default: ""
    - name: revision
      value: "{{ revision }}"
      default: ""
    - name: e2e_test_namespace
      value: build-templates-e2e
      default: ""
  tasks:
    - name: prepare-e2e-tests
      params:
        - name: SNAPSHOT
          value: $(params.SNAPSHOT)
        - name: e2e_test_namespace
          value: $(params.e2e_test_namespace)
        - name: repo_url
          value: $(params.repo_url)
        - name: revision
          value: $(params.revision)
      taskSpec:
        params:
        - name: SNAPSHOT
        steps:
          - name: e2e-tests
            image: quay.io/redhat-appstudio/appstudio-utils:f58ba64422b4d9bbcb4b296fbfe7b60f7793c3c1
            env:
            - name: SNAPSHOT
              value: $(params.SNAPSHOT)
            script: |
              echo "Preparing to run the e2e-tests"
              echo "Got SS: ${SNAPSHOT}"
              SOURCE_IMAGE=$(echo -n ${SNAPSHOT} | jq -r .components[0].containerImage)
              echo "Built image: ${SOURCE_IMAGE}"
    - name: run-e2e-tests
      params:
        - name: e2e_test_namespace
          value: "build-templates-e2e"
        - name: app_suffix
          value: "app-intergration"
        - name: ec_pipelines_repo_url
          value: "https://github.com/tisutisu/integration-tests.gi"
        - name: ec_pipelines_repo_revision
          value: "main"
      runAfter:
        - prepare-e2e-tests
      taskRef:
        resolver: git
        params:
          - name: url
            value: "https://github.com/tisutisu/integration-tests.gi"
          - name: revision
            value: "main"
          - name: pathInRepo
            value: tasks/e2e-test.yaml

      # Added a timeout due to https://issues.redhat.com/browse/STONEBLD-2265
      timeout: "2h"



